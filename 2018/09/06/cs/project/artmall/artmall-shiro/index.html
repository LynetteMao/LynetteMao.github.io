<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>artmall:spingboot整合shiro-基本登录实现 | Hexo</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Hexo">
    <meta name="author" content="John Doe">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

<div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
    <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
        <img src="/img/close.png" alt="Close"/>
    </div>
    <!-- Lists in Slidebars -->
    <ul class="sb-menu">
        <li><a href="/" class="animsition-link" title="Home">Home</a></li>
        <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
        <!-- Dropdown Menu -->
         
        <li>
            <a class="sb-toggle-submenu">Tag<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                
                    <li><a href="/tags/环境搭建/" class="animsition-link">环境搭建</a></li>
                
                    <li><a href="/tags/java/" class="animsition-link">java</a></li>
                
                    <li><a href="/tags/artmall/" class="animsition-link">artmall</a></li>
                
                    <li><a href="/tags/artmall-问题解决/" class="animsition-link">artmall,问题解决</a></li>
                
                    <li><a href="/tags/6-828/" class="animsition-link">6.828</a></li>
                
            </ul>
        </li>
        
        
        <li>
            <a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                  
                <li><a href="/categories/basic/" class="animsition-link">basic<small>(1)</small></a></li>
                
                <li><a href="/categories/operate/" class="animsition-link">operate<small>(3)</small></a></li>
                
                <li><a href="/categories/project/" class="animsition-link">project<small>(4)</small></a></li>
                
            </ul>
        </li>
        
        
        <li>
            <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                
                <li><a href="" class="animsition-link"></a></li>
                
                <li><a href="" class="animsition-link"></a></li>
                
            </ul>
        </li>
        
    </ul>
    <!-- Lists in Slidebars -->
    <ul class="sb-menu secondary">
        
        <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
        <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
    </ul>
</div>

<!-- ============================ END Off-canvas navigation =========================== -->

<!-- ============================ #sb-site Main Page Wrapper =========================== -->

<div id="sb-site">
    <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

    <!-- ============================ Header & Logo bar =========================== -->

    <div id="navigation" class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <!-- Nav logo -->
                <div class="logo">
                    <a href="/" title="Logo" class="animsition-link">
                     <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                    </a>
                </div>
                <!-- // Nav logo -->
                <!-- Info-bar -->
                <nav>
                    <ul class="nav">
                        <li><a href="/" class="animsition-link">Hexo</a></li>
                        <li class="nolink"><span>Always </span>Creative.</li>
                        
                        <li><a href="https://github.com/mllove" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                        
                        
                        
                        
                        
                        <li class="nolink"><span>Welcome!</span></li>
                    </ul>
                </nav>
                <!--// Info-bar -->
            </div>
            <!-- // .container -->
            <div class="learnmore sb-toggle-right">More</div>
            <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar before"></span>
            <span class="icon-bar main"></span>
            <span class="icon-bar after"></span>
            </button>
        </div>
        <!-- // .navbar-inner -->
    </div>

    <!-- ============================ Header & Logo bar =========================== -->
      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2018-09-06T13:40:08.000Z" itemprop="datePublished">
          2018-09-06
      </time>
    
    
    | 
    <a href='/tags/artmall/'>artmall</a>
    
    
</span>
                <h1>artmall:spingboot整合shiro-基本登录实现</h1>
            </div>
        </div>
    
        

   
        


        <div class="col-md-8 col-md-offset-2">
      		<p>我要实现的shiro是多realm且使用jwt进行数据的传输（因为是前后端分离）,一开始我按照网上的直接进行整合，没有通过测试，发现一大堆的错误，却又不知道怎么该。带我的一个小姐姐要我重新全部搭过，一步一步进行测试,所以我要实现shiro的整合一共分为4步：</p>
<p>1、基础的登录实现（就是本篇）</p>
<p>2、实现token</p>
<p>3、实现多realm</p>
<p>4、权限控制</p>
<a id="more"></a>
<p>一、基础知识   </p>
<h3 id="Authentication-Sequence-认证序列"><a href="#Authentication-Sequence-认证序列" class="headerlink" title="Authentication Sequence(认证序列)"></a>Authentication Sequence(认证序列)</h3><ol>
<li>代码调用Subject.login方法，向AuthenticationToken(认证令牌)实例得构造函数传递用户得身份和证明</li>
<li>DelegationSuject通过调用securityManager.login(token)将令牌转交给程序得SecurityManager(如何实现的？后期要进行源码分析)</li>
<li>SecurityManager通过调用authenticator.authenticate(token)将其转交给Authenticator实例(通常为ModularRealmAuthenticator)</li>
<li>如果配置了多个Realm，ModularRealmAuthenticator实例将使用起配置的AuthenticationStrategy开始多Realm身份验证的尝试。</li>
<li>每一个配置的 Realm 都被检验看其是否支持)提交的AuthenticationToken，如果支持，则该 Realm 的 getAuthenticationInfo) 方法随着提交的牌被调用，getAuthenticationInfo<br>方法为特定的 Realm 有效提供一次独立的验证尝试</li>
</ol>
<p>二、步骤</p>
<p>1、添加依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>2、在ssm结构里是用xml文件进行配置，但是springboot里基本不用xml文件，用JavaBean进行配置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建一个ShiroConfiguration.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shiro核心通过Filter实现，通过URL规则进行过滤和权限校验</span></span><br><span class="line"><span class="comment"> * 配置shiro，相当于ssm结构中xml文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//配置过滤器（核心配置）</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shirFilter</span><span class="params">(SecurityManager securityManager)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ShiroConfiguration.shirFilter()"</span>);</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">				<span class="comment">//一定要</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">				Map&lt;String,String&gt; filterChainDefinitionMap =  <span class="keyword">new</span> LinkedHashMap&lt;String,String&gt;();</span><br><span class="line">        <span class="comment">//配置不会被拦截的链接 顺序判断</span></span><br><span class="line">        <span class="comment">//anon:所有url都可以匿名访问</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/static/**"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        <span class="comment">//配置退出,shiro已内置logout过滤器</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/logout"</span>,<span class="string">"logout"</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/register"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/hello"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/info"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/login"</span>,<span class="string">"anon"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//表示需要认证，没有登陆是不能访问的</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>,<span class="string">"authc"</span>);</span><br><span class="line">        <span class="comment">//配置shiro默认登陆界面，不过在前后端分离中应该有前端路由控制</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">"/unauth"</span>);</span><br><span class="line">				<span class="comment">//未授权界面;</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/403"</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//定义自己的myRealm，要重写其验证方式</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> MyRealm <span class="title">myRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        MyRealm myRealm = <span class="keyword">new</span> MyRealm();</span><br><span class="line">	      <span class="keyword">return</span> myRealm;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">	      System.out.println(<span class="string">"securityManager.log"</span>);</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">				securityManager.setRealm(myRealm());</span><br><span class="line">				<span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3、Realm：检查提交的凭证是否和后台数据匹配，要实现AuthorizingRealm里的抽象类doGetAuthenticationInfo，来实现用户的验证</p>
<p>原理：authenticationToken存放的是用户输入信息(通常为用户名和密码，这里的密码是未加密的)，要拿这个信息和数据库里的信息进行比对，shiro通过AuthenticatingRealm使用CredentialsMatcher里面的SimpleCredentialsMatcher进行凭证的比对。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回的信息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SimpleAuthenticationInfo</span><span class="params">(Object principal, Object hashedCredentials, ByteSource credentialsSalt, String realmName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.principals = <span class="keyword">new</span> SimplePrincipalCollection(principal, realmName);</span><br><span class="line">        <span class="keyword">this</span>.credentials = hashedCredentials;</span><br><span class="line">        <span class="keyword">this</span>.credentialsSalt = credentialsSalt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户输入的信息和用户在数据库存储的信息进行比对</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;</span><br><span class="line">        Object tokenCredentials = <span class="keyword">this</span>.getCredentials(token);</span><br><span class="line">        Object accountCredentials = <span class="keyword">this</span>.getCredentials(info);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.equals(tokenCredentials, accountCredentials);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">		<span class="comment">//权限的验证，因为我们现在暂时只考虑登录，所以还没有写</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StudentService studentService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">		</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyShiroRealm.doGetAuthenticationInfo()"</span>);</span><br><span class="line">        UsernamePasswordToken token = (UsernamePasswordToken)authenticationToken;</span><br><span class="line">				<span class="comment">//根据用户输入的studentid查询数据库里student的信息</span></span><br><span class="line">        Student student = studentService.selectStudentByStuId(token.getUsername());</span><br><span class="line">				<span class="comment">//获取数据库里存储的此student的salt</span></span><br><span class="line">        ByteSource salt = ByteSource.Util.bytes(student.getSalt());</span><br><span class="line">        <span class="keyword">if</span> (student!=<span class="keyword">null</span>)&#123; </span><br><span class="line">						<span class="comment">//返回的信息包括了数据库了关于此student的登录凭证</span></span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(student.getStudentId(),student.getHashedPwd(),salt,getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>4、密码加密加盐</p>
<p>shiroConfiguration.java</p>
<p>刚我们说验证使用的是SimpleCredentialsMatcher里面的doCredentialsMatch()进行比对,但是此时，我们数据库里的密码是进行了md5加密的，但是用户输入的密码是没有加盐加密的，所以肯定是不匹配的，HashedCredentialsMatcher extends SimpleCredentialsMatcher，配置使用HashedCredentialsMatcher，实现md5加密。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">      HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">    </span><br><span class="line">      hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">"MD5"</span>);<span class="comment">//散列算法:这里使用MD5算法;</span></span><br><span class="line">      hashedCredentialsMatcher.setHashIterations(<span class="number">1024</span>);<span class="comment">//散列的次数，比如散列两次，相当于 md5(md5(""));</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> MyRealm <span class="title">myRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">      MyRealm myRealm = <span class="keyword">new</span> MyRealm();</span><br><span class="line">      myRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">     <span class="keyword">return</span> myRealm;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：录入信息的时候，也用使用一样的加密方式，最好不要用自己写的MD5工具类，不然生成的不一样。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newStudent.setHashedPwd(<span class="keyword">new</span> SimpleHash(<span class="string">"MD5"</span>,student.getHashedPwd(),ByteSource.Util.bytes(newStudent.getSalt()),<span class="number">1024</span>).toString());</span><br></pre></td></tr></table></figure></p>
<p>三、踩过的坑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: ApplicationEventMulticaster not initialized - call <span class="string">'refresh'</span> before multicasting events via the context</span><br><span class="line"></span><br><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Parameter <span class="number">0</span> of method shiroFilter in com.artmuseum.artmuseumweb.shiro.config.ShiroConfiguration required a bean of type <span class="string">'com.artmuseum.artmuseummanager.service.StudentService'</span> that could not be found.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Consider defining a bean of type <span class="string">'com.artmuseum.artmuseummanager.service.StudentService'</span> in your configuration.</span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'shirFilter' defined in class path resource [com/artmall/shiro/config/ShiroConfiguration.class]: Unsatisfied dependency expressed through method 'shirFilter' parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'securityManager' defined in class path resource [com/artmall/shiro/config/ShiroConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.shiro.mgt.SecurityManager]: Factory method 'securityManager' threw exception; nested exception is java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.shiro.realm.Realm</span><br><span class="line">	</span><br><span class="line">Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'securityManager' defined in class path resource [com/artmall/shiro/config/ShiroConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.shiro.mgt.SecurityManager]: Factory method 'securityManager' threw exception; nested exception is java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.shiro.realm.Realm</span><br><span class="line"></span><br><span class="line">Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.shiro.mgt.SecurityManager]: Factory method <span class="string">'securityManager'</span> threw exception; nested exception is java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.shiro.realm.Realm</span><br><span class="line">	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:<span class="number">185</span>) ~[spring-beans-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">	at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:<span class="number">582</span>) ~[spring-beans-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">	... <span class="number">37</span> common frames omitted</span><br><span class="line">Caused by: java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.shiro.realm.Realm</span><br><span class="line">	at com.artmall.shiro.config.ShiroConfiguration.securityManager(ShiroConfiguration.java:<span class="number">108</span>) ~[classes/:na]</span><br><span class="line">	at com.artmall.shiro.config.ShiroConfiguration$$EnhancerBySpringCGLIB$$<span class="number">926e0583</span>.CGLIB$securityManager$<span class="number">0</span>(&lt;generated&gt;) ~[classes/:na]</span><br><span class="line">	at com.artmall.shiro.config.ShiroConfiguration$$EnhancerBySpringCGLIB$$<span class="number">926e0583</span>$$FastClassBySpringCGLIB$$e22b6d11.invoke(&lt;generated&gt;) ~[classes/:na]</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invokeSuper(MethodProxy.java:<span class="number">228</span>) ~[spring-core-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">	at org.springframework.context.annotation.ConfigurationClassEnhancer$BeanMethodInterceptor.intercept(ConfigurationClassEnhancer.java:<span class="number">361</span>) ~[spring-context-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">	at com.artmall.shiro.config.ShiroConfiguration$$EnhancerBySpringCGLIB$$<span class="number">926e0583</span>.securityManager(&lt;generated&gt;) ~[classes/:na]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:<span class="number">1.8</span>.0_161]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>) ~[na:<span class="number">1.8</span>.0_161]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>) ~[na:<span class="number">1.8</span>.0_161]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>) ~[na:<span class="number">1.8</span>.0_161]</span><br><span class="line">	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:<span class="number">154</span>) ~[spring-beans-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">	... <span class="number">38</span> common frames omitted</span><br></pre></td></tr></table></figure></p>
<ul>
<li>添加解密规则后  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置文件里增加使用hash解密规则</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"hashedCredentialsMatcher"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"解密规则"</span>);</span><br><span class="line">            HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">            <span class="comment">//采用MD5方式加密</span></span><br><span class="line">            hashedCredentialsMatcher().setHashAlgorithmName(<span class="string">"MD5"</span>);</span><br><span class="line">            <span class="keyword">return</span> hashedCredentialsMatcher();</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="comment">//但是依旧报错</span></span><br><span class="line"></span><br><span class="line">    org.apache.shiro.UnavailableSecurityManagerException: No SecurityManager accessible to the calling code, either bound to the org.apache.shiro.util.ThreadContext or as a vm <span class="keyword">static</span> singleton. This is an invalid application configuration.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//估计是加密方法有问题，就改了加密次数</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">            HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">            <span class="comment">//采用MD5方式加密</span></span><br><span class="line">            hashedCredentialsMatcher().setHashAlgorithmName(<span class="string">"MD5"</span>);</span><br><span class="line">            hashedCredentialsMatcher.setHashIterations(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//        System.out.println("解密规则");</span></span><br><span class="line">            <span class="keyword">return</span> hashedCredentialsMatcher();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//依旧报错</span></span><br><span class="line">    Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.shiro.authc.credential.HashedCredentialsMatcher]: Factory method <span class="string">'hashedCredentialsMatcher'</span> threw exception; nested exception is java.lang.StackOverflowError</span><br><span class="line">    	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:<span class="number">185</span>) ~[spring-beans-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">    	at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:<span class="number">582</span>) ~[spring-beans-<span class="number">5.0</span>.8.RELEASE.jar:<span class="number">5.0</span>.8.RELEASE]</span><br><span class="line">    	... <span class="number">65</span> common frames omitted</span><br><span class="line">    Caused by: java.lang.StackOverflowError: <span class="keyword">null</span></span><br></pre></td></tr></table></figure>
<p>最后发现是，在密码录入数据库的时候加密方式和验证方式不是同一种，自然不能匹配，把验证方式改为一致后，就成功了！</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>


        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2018/09/25/cs/project/artmall/authorization/" style="float: left;">
        ← artmall——authorization
    </a>
    
    
    <a class="pull-right" href="/2018/09/06/cs/project/artmall/artmall-springboot/">
        artmall:multi module sping boot搭建 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By John Doe. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/mllove" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
